<!DOCTYPE html>
<meta charset="utf-8">
<style>

.links line {
  stroke: #999;
  stroke-opacity: 0.6;
}

.nodes circle {
  stroke: #fff;
  stroke-width: 1.5px;
}

div.tooltip { 
    position: absolute;     
    text-align: center;     
    width: 120px;          
    height: 80px;         
    padding: 2px;       
    font: 12px sans-serif;    
    background: lightsteelblue; 
    border: 0px;    
    border-radius: 8px;     
    pointer-events: none;     
}

.node text {
  font: 9px helvetica;
}

</style>
<svg width="960" height="600"></svg>
<script src="https://d3js.org/d3.v4.min.js"></script>

<script>
var width = 960;
var height = 600;
var radius = 15;

var weights = [1, 1, 1, 1, 1, 1, 1, 1, 1, 1];
var maxPossVal = 0;
var maxVal = 0;
for(var i = 0; i < weights.length; i++) {
  maxPossVal += weights[i];
}

function calcDist(f1, f2) {
  // acousticness, danceability, energy, instrumentalness, key, liveness, mode, speechiness, tempo, valence
  var values = []
  values.push(Math.abs(f1.acousticness - f2.acousticness))
  values.push(Math.abs(f1.danceability - f2.danceability))
  values.push(Math.abs(f1.energy - f2.energy))
  values.push(Math.abs(f1.instrumentalness - f2.instrumentalness))
  if(f1.key == f2.key) {
    values.push(0)
  }
  else {
    values.push(1)
  }
  values.push(Math.abs(f1.liveness - f2.liveness))
  if(f1.mode == f2.mode) {
    values.push(0)
  }
  else {
    values.push(1)
  }
  values.push(Math.abs(f1.speechiness - f2.speechiness))
  values.push(Math.abs(f1.tempo - f2.tempo) / 200)
  values.push(Math.abs(f1.valence - f2.valence))
  var dist = 0;
  for(var i=0; i < values.length; i++) {
    dist += values[i] * weights[i];
  }
  return dist;
}

function compareLinks(link1, link2) {
  return link1.value - link2.value
}

function generateLinks(nodes) {
  var links = []
  var linksByNode = []
  for(var i = 0; i < nodes.length; i++) {
    var thisNodeLinks = []
    for(var j = 0; j < nodes.length; j++) {
      if(i != j) {
        var source = nodes[i].id
        var target = nodes[j].id
        dist = calcDist(nodes[i].features, nodes[j].features)
        console.log(dist)
        links.push({source: source, target: target, value: dist})
        thisNodeLinks.push({source: source, target: target, value: dist})
      }
    }
    linksByNode.push(thisNodeLinks)
  }
  links.sort(compareLinks)
  var toKeep = Math.ceil(links.length * .2)
  var topLinks = links.splice(0, toKeep)
  var linkList = topLinks
  for(var i = 0; i < linksByNode.length; i++) {
    toKeep = 1//Math.ceil(linksByNode[i].length * .1)
    linkList = linkList.concat(linksByNode[i].sort(compareLinks).splice(0, toKeep))
  }
  linkList.sort(compareLinks)
  maxVal = linkList[linkList.length-1].value
  return linkList
}

/*var data = 
[
{id:1000, name:"Song 1", artist:["Artist 1", "Artist 2"], sample:"filler", 
  features:{loudness:10, danceability:Math.random(), key:Math.floor(Math.random()*6), mode:Math.floor(Math.random()*3), speechiness:Math.random(), acousticness:Math.random(), instrumentalness:Math.random(), liveness:Math.random(), valence:Math.random(), tempo:Math.floor(Math.random()*201), energy:Math.random()}},
{id:1001, name:"Song 2", artist:["Artist 1"], sample:"filler", 
  features:{loudness:10, danceability:Math.random(), key:Math.floor(Math.random()*6), mode:Math.floor(Math.random()*3), speechiness:Math.random(), acousticness:Math.random(), instrumentalness:Math.random(), liveness:Math.random(), valence:Math.random(), tempo:Math.floor(Math.random()*201), energy:Math.random()}},
{id:1002, name:"Song 3", artist:["Artist 2"], sample:"filler", 
  features:{loudness:10, danceability:Math.random(), key:Math.floor(Math.random()*6), mode:Math.floor(Math.random()*3), speechiness:Math.random(), acousticness:Math.random(), instrumentalness:Math.random(), liveness:Math.random(), valence:Math.random(), tempo:Math.floor(Math.random()*201), energy:Math.random()}},
{id:1003, name:"Song 4", artist:["Artist 2"], sample:"filler", 
  features:{loudness:10, danceability:Math.random(), key:Math.floor(Math.random()*6), mode:Math.floor(Math.random()*3), speechiness:Math.random(), acousticness:Math.random(), instrumentalness:Math.random(), liveness:Math.random(), valence:Math.random(), tempo:Math.floor(Math.random()*201), energy:Math.random()}},
{id:1004, name:"Song 5", artist:["Artist 3"], sample:"filler", 
  features:{loudness:10, danceability:Math.random(), key:Math.floor(Math.random()*6), mode:Math.floor(Math.random()*3), speechiness:Math.random(), acousticness:Math.random(), instrumentalness:Math.random(), liveness:Math.random(), valence:Math.random(), tempo:Math.floor(Math.random()*201), energy:Math.random()}},
{id:1005, name:"Song 6", artist:["Artist 3"], sample:"filler", 
  features:{loudness:10, danceability:Math.random(), key:Math.floor(Math.random()*6), mode:Math.floor(Math.random()*3), speechiness:Math.random(), acousticness:Math.random(), instrumentalness:Math.random(), liveness:Math.random(), valence:Math.random(), tempo:Math.floor(Math.random()*201), energy:Math.random()}},
{id:1006, name:"Song 7", artist:["Artist 4"], sample:"filler", 
  features:{loudness:10, danceability:Math.random(), key:Math.floor(Math.random()*6), mode:Math.floor(Math.random()*3), speechiness:Math.random(), acousticness:Math.random(), instrumentalness:Math.random(), liveness:Math.random(), valence:Math.random(), tempo:Math.floor(Math.random()*201), energy:Math.random()}},
{id:1007, name:"Song 8", artist:["Artist 4"], sample:"filler", 
  features:{loudness:10, danceability:Math.random(), key:Math.floor(Math.random()*6), mode:Math.floor(Math.random()*3), speechiness:Math.random(), acousticness:Math.random(), instrumentalness:Math.random(), liveness:Math.random(), valence:Math.random(), tempo:Math.floor(Math.random()*201), energy:Math.random()}},
{id:1008, name:"Song 9", artist:["Artist 4"], sample:"filler", 
  features:{loudness:10, danceability:Math.random(), key:Math.floor(Math.random()*6), mode:Math.floor(Math.random()*3), speechiness:Math.random(), acousticness:Math.random(), instrumentalness:Math.random(), liveness:Math.random(), valence:Math.random(), tempo:Math.floor(Math.random()*201), energy:Math.random()}},
{id:1009, name:"Song 10", artist:["Artist 4"], sample:"filler", 
  features:{loudness:10, danceability:Math.random(), key:Math.floor(Math.random()*6), mode:Math.floor(Math.random()*3), speechiness:Math.random(), acousticness:Math.random(), instrumentalness:Math.random(), liveness:Math.random(), valence:Math.random(), tempo:Math.floor(Math.random()*201), energy:Math.random()}},
{id:1010, name:"Song 11", artist:["Artist 5"], sample:"filler", 
  features:{loudness:10, danceability:Math.random(), key:Math.floor(Math.random()*6), mode:Math.floor(Math.random()*3), speechiness:Math.random(), acousticness:Math.random(), instrumentalness:Math.random(), liveness:Math.random(), valence:Math.random(), tempo:Math.floor(Math.random()*201), energy:Math.random()}},
{id:1011, name:"Song 12", artist:["Artist 6"], sample:"filler", 
  features:{loudness:10, danceability:Math.random(), key:Math.floor(Math.random()*6), mode:Math.floor(Math.random()*3), speechiness:Math.random(), acousticness:Math.random(), instrumentalness:Math.random(), liveness:Math.random(), valence:Math.random(), tempo:Math.floor(Math.random()*201), energy:Math.random()}},
];*/
var data = [
{id:1, name: "Love Lies", artist: ["Khalid", "Normani"], features: {acousticness:0.0956, danceability:0.708, energy:0.648, instrumentalness:0, key:6, liveness:0.134, loudness:-5.626, mode:1, popularity:98, speechiness:0.0449, tempo:143.955, valence:0.338}},
{id:2, name: "Dangerously In Love", artist: ["BeyoncÃ©", "JAY Z"], features: {acousticness:0.00249, danceability:0.646, energy:0.77, instrumentalness:0, key:2, liveness:0.0715, loudness:-6.596, mode:0, popularity:80, speechiness:0.226, tempo:99.165, valence:0.681}},
{id:3, name: "Bad at Love", artist: ["Halsey"], features: {acousticness:0.06, danceability:0.675, energy:0.736, instrumentalness:0, key:0, liveness:0.0879, loudness:-3.604, mode:1, popularity:82, speechiness:0.0302, tempo:118.369, valence:0.607}},
{id:4, name: "Mad Love", artist: ["Sean Paul", "David Guetta", "Becky G"], features: {acousticness:0.00523, danceability:0.804, energy:0.823, instrumentalness:0, key:11, liveness:0.168, loudness:-3.496, mode:0, popularity:83, speechiness:0.147, tempo:98.026, valence:0.619}}
]

var artists = [];
for(var i = 0; i < data.length; i++) {
  artists.push(data[i].artist[0]);
}

links = generateLinks(data)

var graph = {
  "nodes": data,
  "links": links
}

var svg = d3.select("svg"),
    width = +svg.attr("width"),
    height = +svg.attr("height");

var color = d3.scaleOrdinal(d3.schemeCategory10);

var tooltip = d3.select("body").append("div") 
    .attr("class", "tooltip")       
    .style("opacity", 0);

var link = svg.append("g")
  .attr("class", "links")
  .selectAll("line")
  .data(graph.links)
  .enter().append("line")
  .attr("stroke-width", function(d) { return 1.5*(maxVal - d.value + 1); })
  .on("mouseover", function(d) {    
      tooltip.transition()    
             .duration(200)    
             .style("opacity", .9);    
      tooltip.html(d.value)  
             .style("left", (d3.event.pageX) + "px")   
             .style("top", (d3.event.pageY - 28) + "px");  
    })          
    .on("mouseout", function(d) {   
      tooltip.transition()    
             .duration(500)    
             .style("opacity", 0); 
    });


var node = svg.append("g")
    .attr("class", "nodes")
    .selectAll("circle")
    .data(graph.nodes)
    .enter().append("circle")
    .attr("r", radius)
    .attr("fill", function(d) { return color(artists.indexOf(d.artist[0])); })
    .call(d3.drag()
          .on("start", dragstarted)
          .on("drag", dragged)
          .on("end", dragended))
    .on("mouseover", function(d) {    
      tooltip.transition()    
             .duration(200)    
             .style("opacity", .9);    
      tooltip.html("Title: " + d.name + "<br/>Artist(s): " + d.artist.join(", "))  
             .style("left", (d3.event.pageX) + "px")   
             .style("top", (d3.event.pageY - 28) + "px");  
    })          
    .on("mouseout", function(d) {   
      tooltip.transition()    
             .duration(500)    
             .style("opacity", 0); 
    });


var simulation = d3.forceSimulation()
    .force("link", d3.forceLink().id(function(d) { return d.id; }).distance(function(d) { return d.value * 30}))
    .force("charge", d3.forceManyBody().strength(function(d) {return d.value*-30})  .strength(-300))
    .force("center", d3.forceCenter(width / 2, height / 2))
    .force("collide", d3.forceCollide().radius(15));

simulation
    .nodes(graph.nodes)
    .on("tick", ticked);

simulation.force("link")
    .links(graph.links);


function ticked() {
  link
      .attr("x1", function(d) { return d.source.x; })
      .attr("y1", function(d) { return d.source.y; })
      .attr("x2", function(d) { return d.target.x; })
      .attr("y2", function(d) { return d.target.y; });

  node
      .attr("cx", function(d) { return d.x = Math.max(radius, Math.min(width - radius, d.x)); })
      .attr("cy", function(d) { return d.y = Math.max(radius, Math.min(height - radius, d.y)); });
}

function dragstarted(d) {
  if (!d3.event.active) simulation.alphaTarget(0.3).restart();
  d.fx = d.x;
  d.fy = d.y;
}

function dragged(d) {
  d.fx = Math.max(radius, Math.min(width - radius, d3.event.x));
  d.fy = Math.max(radius, Math.min(height - radius, d3.event.y));
}

function dragended(d) {
  if (!d3.event.active) simulation.alphaTarget(0);
  d.fx = null;
  d.fy = null;
}

</script>